<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>hello</title>
  </head>
  <body><main><div class="page-owner"><section class="page show" id="page1"><h1 id="page1.test-template">Test Template</h1>
<p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Minima magni nisi
fugit optio, nam qui vitae adipisci ullam rerum aut libero dolorum,
exercitationem pariatur ipsam consequuntur maiores, aliquid in assumenda.</p>
<h2 id="page1.1.-read">1. Read</h2>
<ul>
<li>シングルクォーテーション「'」</li>
<li>ダブルクォーテーション「"」</li>
<li>シングル &amp; ダブルクォーテーション「'"」</li>
<li>文字実体参照: &lt;</li>
</ul>
<h2 id="page1.2.-hello%E3%82%92%E5%87%BA%E5%8A%9B%E3%81%99%E3%82%8B">2. Helloを出力する</h2>
<h2 id="page1.2-1.-c%E8%A8%80%E8%AA%9E">2-1. C言語</h2>
<pre><code class="language-c">#include &lt;stdio.h&gt;
int main(void)
{
  printf("Hello\n");
}
</code></pre>
<h2 id="page1.2-2.-c%23">2-2. C#</h2>
<p>忘れた。</p>
<pre><code class="language-csharp">using System;
public class Hello {
  public static void Main() {
    Console.WriteLine("Hello");
  }
}
</code></pre>
<p>Visual Studio では <code>cw</code> が Console.WriteLine のスニペットになっている。</p>
<h2 id="page1.2-2.-javascript">2-2. JavaScript</h2>
<pre><code class="language-js">console.log("Hello");
</code></pre>
<h2 id="page1.3.">3.</h2>
<h2 id="page1.link">Link</h2>
<ul>
<li><a href="#page1">test-template</a></li>
<li><a href="#page2">test-template2</a></li>
</ul>
<h2 id="page1.test-template-1">Test template</h2>
<p>WebdriverIO で template をテストする。</p>
<p><code>search.e2e.js</code></p>
<ul>
<li>Searcher class _getElementsByText</li>
</ul>
</section><section class="page" id="page2"><h1 id="page2.test-template-2">Test Template 2</h1>
<p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Minima magni nisi
fugit optio, nam qui vitae adipisci ullam rerum aut libero dolorum,
exercitationem pariatur ipsam consequuntur maiores, aliquid in assumenda.</p>
<p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Minima magni nisi
fugit optio, nam qui vitae adipisci ullam rerum aut libero dolorum,
exercitationem pariatur ipsam consequuntur maiores, aliquid in assumenda.</p>
<p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Minima magni nisi
fugit optio, nam qui vitae adipisci ullam rerum aut libero dolorum,
exercitationem pariatur ipsam consequuntur maiores, aliquid in assumenda.</p>
<h2 id="page2.%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%B3">テンプレートエンジン</h2>
<ul>
<li><a href="https://pugjs.org/">Pug</a></li>
<li><a href="https://ejs.co/">EJS</a></li>
</ul>
<h2 id="page2.html">HTML</h2>
<div style="background-color: red; width: 50px; height: 50px;"></div>
<h2 id="page2.link">Link</h2>
<ul>
<li><a href="#page1">test-template</a></li>
<li><a href="#page2">test-template2</a></li>
</ul>
</section></div></main><header class="index">
<form class="search-field">
  <input id="search-text" type="text"/>
  <div class="search-buttons">
    <button id="search-button">検索</button>
    <button id="search-reset-button">リセット</button>
  </div>
</form>
<hr />
<div><ul><li><a href="#page1">page1</a></li><li><a href="#page1.test-template">Test Template</a></li><li><a href="#page1.1.-read">1. Read</a></li><li><a href="#page1.2.-hello%E3%82%92%E5%87%BA%E5%8A%9B%E3%81%99%E3%82%8B">2. Helloを出力する</a></li><li><a href="#page1.2-1.-c%E8%A8%80%E8%AA%9E">2-1. C言語</a></li><li><a href="#page1.2-2.-c%23">2-2. C#</a></li><li><a href="#page1.2-2.-javascript">2-2. JavaScript</a></li><li><a href="#page1.3.">3.</a></li><li><a href="#page1.link">Link</a></li><li><a href="#page1.test-template-1">Test template</a></li></ul></div><div><ul><li><a href="#page2">page2</a></li><li><a href="#page2.test-template-2">Test Template 2</a></li><li><a href="#page2.%E3%83%86%E3%83%B3%E3%83%97%E3%83%AC%E3%83%BC%E3%83%88%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%B3">テンプレートエンジン</a></li><li><a href="#page2.html">HTML</a></li><li><a href="#page2.link">Link</a></li></ul></div>
</header><script>function paging() {
  var href = window.location.href;
  var hash = window.location.hash;
  if (hash) {
    var currentPage = document.querySelector('.page.show');
    var h = hash.split('.')[0];
    if (currentPage && currentPage.getAttribute('id') === h.replace('#', '')) {
      // noop
    } else {
      currentPage.classList.remove('show');
      var nextPage = document.querySelector(h);
      if (nextPage) {
        nextPage.classList.add('show');
        document.title = h.replace('#', '');
        window.location.href = href;
      } else {
        alert('ページがありません。');
      }
    }
  } else {
    // noop
  }
}
</script><script>var Searcher = (function () {
  function Searcher() {
    this.result = [];
    // ToDo: ホワイトリストの方がいい。
    this.tagsToBeExcluded = [
      'script',
      'style',
      'meta',
      'head',
      'title',
      'link',
    ];
  }

  Searcher.prototype._getElementsByText = function (text, rootTag) {
    /** @type {HTMLElement[]} */
    var elements = [];

    if (text.length === 0) return elements;

    // main タグ以下を検索
    var expression = this._makeXPathExprSearchDeepestNodeContaining(
      text,
      rootTag
    );

    var xPathResult = document.evaluate(
      expression,
      document,
      null,
      XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,
      null
    );

    if (xPathResult.snapshotLength) {
      var length = xPathResult.snapshotLength;

      while (length--) {
        var item = xPathResult.snapshotItem(length);

        if (
          this.tagsToBeExcluded.findIndex(function (tag) {
            return tag === item.nodeName.toLowerCase();
          }) >= 0
        ) {
          // Exclude this Node
        } else {
          elements.push(item);
        }
      }
    }

    return elements;
  };

  Searcher.prototype.search = function (text, callback) {
    if (this.result.length > 0) {
      this.reset();
    }

    var elements = this._getElementsByText(text, 'main');

    if (elements && elements.length) {
      for (var i = 0; i < elements.length; i++) {
        var element = elements[i];
        this.result.push({
          element: element,
          bufferedHTML: element.innerHTML,
        });

        if (callback && typeof callback === 'function') {
          callback(element);
        }

        var htmlEscaped = this._escapeHtml(text);
        element.innerHTML = element.innerHTML.replaceAll(
          htmlEscaped,
          '<span class="search-hit-text">' + htmlEscaped + '</span>'
        );
      }
    }
  };

  Searcher.prototype.reset = function () {
    while (this.result.length) {
      var item = this.result.pop();
      item.element.innerHTML = item.bufferedHTML;
    }
  };

  /**
   * var expression =
   *   '//*[contains(text(), ' + escapeXPathExpr(text) + ')]';
   * テキストが部分一致している要素を取得する。
   * ただし、以下のような例の ipsum を検索し取得することができない。
   *
   * <div>
   *   <p>lorem</p>
   *   ipsum
   * </div>
   *
   * text() を . に置き換えると、 ipsum が検索できるが、親ノードまですべて取得してしまう。
   * var expression = '//*[contains(., ' + escapeXPathExpr(text) + ')]';
   *
   * ipsum も検索できるように下記リンク先を参考に改善した。
   * https://stackoverflow.com/questions/53906387/select-all-deepest-nodes-with-xpath-1-0-containing-text-ignoring-markup
   *
   * 完全一致: '//*[normalize-space()="ipsum" and not(./*[normalize-space()="ipsum"])]'
   * 部分一致: '//*[contains(normalize-space(), "ipsum") and not(./*[contains(normalize-space(), "ipsum")])]'
   *
   * @param {string} text 検索文字列
   * @param {string|undefined} rootTag rootTagで指定したタグ以下から検索する。未指定の場合には最上位タグ以下から検索する。
   */
  Searcher.prototype._makeXPathExprSearchDeepestNodeContaining = function (
    text,
    rootTag
  ) {
    var target = '//*';
    if (rootTag !== undefined) {
      target = '//' + rootTag + target;
    }

    return (
      target +
      '[contains(normalize-space(), ' +
      this._escapeXPathExpr(text) +
      ') and not(./*[contains(normalize-space(), ' +
      this._escapeXPathExpr(text) +
      ')])]'
    );
  };

  /**
   * XPathのエスケープ処理
   *
   * バージョン2より前のXPathはエスケープに対応していない。かつ、多くのブラウザはバージョン2のXPathに対応していない。
   * 必然的にブラウザでXPathを利用する際には自前でエスケープ処理を行う必要がある。
   *
   * https://amachang.hatenablog.com/entry/20090917/1253179486
   * XPath に文字列を埋め込むときの注意 - IT戦記 amachang (id:amachang)
   *
   * @param {string} text XPath文字列
   * @returns string エスケープされたXPath文字列
   */
  Searcher.prototype._escapeXPathExpr = function (text) {
    var matches = text.match(/[^"]+|"/g);

    function esc(t) {
      return t == '"' ? "'" + t + "'" : '"' + t + '"';
    }

    if (matches) {
      if (matches.length == 1) {
        return esc(matches[0]);
      } else {
        var results = [];
        for (var i = 0; i < matches.length; i++) {
          results.push(esc(matches[i]));
        }
        return 'concat(' + results.join(', ') + ')';
      }
    } else {
      return '""';
    }
  };

  /**
   * https://qiita.com/saekis/items/c2b41cd8940923863791
   *
   * @param {*} text
   */
  Searcher.prototype._escapeHtml = function (text) {
    return text.replace(/[&'`"<>]/g, function (match) {
      return {
        '&': '&amp;',
        "'": '&#x27;',
        '`': '&#x60;',
        '"': '&quot;',
        '<': '&lt;',
        '>': '&gt;',
      }[match];
    });
  };

  return Searcher;
})();
</script><script>(function (paging, Searcher) {
  window.addEventListener('hashchange', paging);
  window.addEventListener('DOMContentLoaded', paging);

  var searchText = document.querySelector('#search-text');
  var searchButton = document.querySelector('#search-button');
  var searchResetButton = document.querySelector('#search-reset-button');
  if (searchText && searchButton && searchResetButton) {
    if (document.evaluate && typeof document.evaluate === 'function') {
      window.searcher = new Searcher();
      searchButton.addEventListener('click', function (e) {
        e.preventDefault();
        window.searcher.search(searchText.value);
      });
      searchResetButton.addEventListener('click', function (e) {
        e.preventDefault();
        window.searcher.reset();
        searchText.value = '';
      });
    } else {
      searchText.setAttribute(
        'placeholder',
        'お使いのブラウザでは検索を利用できません。'
      );
      searchText.style.fontSize = '10px';
      searchText.setAttribute('disabled', 'true');
      searchButton.setAttribute('disabled', 'true');
      searchResetButton.setAttribute('disabled', 'true');
    }
  }
})(paging, Searcher);
</script><style>* {
  box-sizing: border-box;
}

h1 {
  color: white;
  background-color: rgb(45, 119, 119);
  padding: 8px;
  margin: 5px 0px;
}

h2 {
  border-bottom: 3px solid rgb(45, 119, 119);
}

h3 {
  border-left: 3px solid rgb(45, 119, 119);
  padding-left: 3px;
}

/* 記事 */
.page-owner {
  margin-left: 200px;
  margin-bottom: 90vh;
}

/* ページ切り替え */
.page-owner > .page {
  display: none;
}

.page-owner > .page.show {
  display: block;
}

.page-owner > .page > * {
  max-width: 100%;
}

/* 目次 */
header.index {
  position: fixed;
  height: 100%;
  width: 200px;
  top: 0;
  left: 0;
  background-color: rgb(45, 119, 119);
  padding: 5px 5px;
}

header.index ul {
  list-style: none;
  margin: 0;
  padding: 0;
}

header.index li {
  margin: 0;
  padding: 0;
}

header.index a {
  color: white;
  text-decoration: none;
}

header > hr {
  border-top: 1px dashed #8c8b8b;
  border-bottom: 1px dashed #fff;
}

/* 検索 */
header > .search-field {
  display: flex;
  flex-direction: column;
}

header > .search-field > .search-buttons {
  display: flex;
  flex-direction: row;
}

header > .search-field > .search-buttons > #search-button {
  width: 60%;
}

header > .search-field > .search-buttons > #search-reset-button {
  width: 40%;
}

@-webkit-keyframes bg-color {
  0% {
    background-color: white;
  }
  100% {
    background-color: rgb(255, 180, 180);
  }
}
@keyframes bg-color {
  0% {
    background-color: white;
  }
  100% {
    background-color: rgb(255, 180, 180);
  }
}
.search-hit-text {
  color: black;
  background-color: white;
  -webkit-animation: bg-color 1s infinite;
  animation: bg-color 1s infinite;
}
</style></body>
</html>
